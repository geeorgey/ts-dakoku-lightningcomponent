public class yourAttendanceController {
    //åˆæœŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è¡¨ç¤ºéè¡¨ç¤ºã‚’åˆ¤å®šã™ã‚‹
	@AuraEnabled
    public static LIST<object> isSetMyAttendance() {
        //åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        loadDataResponseData ld = loadData() ;
        //åˆæœŸãƒ‡ãƒ¼ã‚¿ã®é…ç½®
        List<teamspirit__AtkEmpDay__c> empDays = ld.empDays;//å‹¤æ€ æ—¥æ¬¡ãƒªã‚¹ãƒˆ
        String empId = ld.empId;
        Integer yearMonth = ld.yearMonth;
        String startDate = ld.startDate;
        String lastModifiedDate = ld.lastModifiedDate;
        Integer stdStartTime = ld.stdStartTime;
        Integer stdEndTime = ld.stdEndTime;
        teamspirit__AtkEmpDay__c empToday = ld.empToday; //ä»Šæ—¥ã®å‹¤æ€ æ—¥æ¬¡   
        Map<String, Object> lastData = ld.lastData;
        //åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ã“ã“ã¾ã§

        //æœ¬æ—¥ã®çŠ¶æ³ã‚’å–å¾—
		TimeTableResponse res = new TimeTableResponse();
        timeTableResponseData ttrd = new timeTableResponseData();
        //æœ¬æ—¥ã®çŠ¶æ³ã‚’å–å¾—
        List<Map<String, Integer>> timeTable = new List<Map<String, Integer>>();
        ttrd = getTimeTable(res,empToday,timeTable);        
        res.timeTable = timeTable;
        system.debug('ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã¨ã‚Œã¦ã„ã‚‹ã‹ ' + timeTable);
        //å–ã‚Œã¦ãŸï¼š13:27:32:491 USER_DEBUG [50]|DEBUG|ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã¨ã‚Œã¦ã„ã‚‹ã‹ ({from=null, to=null, type=1})

        system.debug('ãƒ¬ã‚¹' + res );
		//18:31:38:491 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=540, to=1080, type=1}, {from=690, to=780, type=21})] å‡ºé€€å‹¤ä¸¡æ–¹ã‚ã‚‹
		//18:33:06:540 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=null, to=null, type=1})] å‡ºé€€å‹¤ä¸¡æ–¹ç„¡ã„
		//18:33:50:547 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=540, to=null, type=1}, {from=690, to=780, type=21})] å‡ºå‹¤ã ã‘ã‚ã‚‹
		//18:34:29:491 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=540, to=1065, type=1}, {from=690, to=780, type=21})]
		//18:36:25:629 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=480, to=null, type=1}, {from=690, to=780, type=21})] 8æ™‚å‡ºå‹¤ã®ã¿
		//18:37:24:551 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=480, to=1200, type=1}, {from=690, to=780, type=21})] 8æ™‚å‡ºå‹¤20æ™‚é€€ç¤¾
		//18:38:40:491 USER_DEBUG [46]|DEBUG|res TimeTableResponse:[isHoliday=false, timeTable=({from=660, to=null, type=1}, {from=690, to=780, type=21})] 11æ™‚å‡ºç¤¾ã®ã¿
		// timeTable[1]ã¯è£é‡åŠ´åƒã®åŸºæœ¬åŠ´åƒæ™‚é–“ã ã¨æ€ã†ã€‚è¨­å®šã—ã¦ã‚ã‚‹ã¨å¤‰åŒ–ã—ãªã„
		system.debug('ãƒ¬ã‚¹res.get(timeTable) ' + res.timeTable);        
		system.debug('res.get(timeTable)from ' + res.timeTable[0].get('from'));
        //å‡ºé€€å‹¤ä¸¡æ–¹ç„¡ã„å ´åˆã¯ res.timeTable == NULL
        //å‡ºå‹¤ã ã‘ã‚ã‚‹å ´åˆã¯  res.timeTable[0].get('from') != NULL && res.timeTable[0].get('to') == NULL
        //ä¸¡æ–¹ã‚ã‚‹å ´åˆã¯ res.timeTable[0].get('from') != NULL && res.timeTable[0].get('to') != NULL
        
        //ç¾åœ¨æ™‚åˆ»ã®å–å¾—
        Datetime now = Datetime.now();
        Integer nowHour = now.hour();

        

        //ã‚«ãƒ¼ãƒ‰ã®å‡ºåŠ›
        //ä¸¡æ–¹ã‚ã‚‹å ´åˆã¯éè¡¨ç¤ºã«ã™ã‚‹

        LIST<object> showOrHide = new LIST<object>();
        //showOrHide[0]ã®è¨­å®šã“ã“ã‹ã‚‰ï¼šcardå…¨ä½“ã®è¡¨ç¤ºéè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
        if(nowHour<=15){// ã€œ15:59
            if(res.timeTable[0].get('from') != NULL){// ã€œ15:59ã§å‡ºå‹¤æ‰“åˆ»ãŒã‚ã‚‹å ´åˆ
                showOrHide.add('false');//cardã‚’æ¶ˆã™
            }else{
                showOrHide.add('true');//cardã‚’è¡¨ç¤º
            }
        }else{// 15:59ã€œ
            if(res.timeTable[0].get('to') != NULL){// 15:59ã€œã§é€€å‹¤æ‰“åˆ»ãŒã‚ã‚‹å ´åˆ
                showOrHide.add('false');//cardã‚’æ¶ˆã™
            }else{
                showOrHide.add('true');//cardã‚’è¡¨ç¤º
            }
        }
        //showOrHide[0]ã®è¨­å®šã“ã“ã¾ã§
        
        //showOrHide[1]ã¨[2]ã®è¨­å®šã“ã“ã‹ã‚‰
        //ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºæ–‡è¨€
        if(nowHour<=15){//ã€œ15:59
            showOrHide.add('å‡ºå‹¤æ‰“åˆ»ã™ã‚‹');
            showOrHide.add('');//showOrHide[2] æœã¯éè¡¨ç¤º
        }else{
            if(res.timeTable[0].get('from') != NULL){// ã€œ15:59ã§å‡ºå‹¤æ‰“åˆ»ãŒã‚ã‚‹å ´åˆ
                showOrHide.add('é€€å‹¤æ‰“åˆ»ã™ã‚‹');       
                showOrHide.add('');//showOrHide[2]
            }else{
                showOrHide.add('é€€å‹¤æ‰“åˆ»ã™ã‚‹');
                showOrHide.add('<p class="slds-text-color_error">å‡ºç¤¾æ‰“åˆ»ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ˜æ—¥ã¯ã‚ˆã‚ã—ããŠã­ãŒã„ã—ã¾ã™ã€‚</p>');//showOrHide[2]
            }
        } 
        //showOrHide[1]ã®è¨­å®šã“ã“ã¾ã§

        //debugç”¨
        showOrHide.add(empId);
        showOrHide.add(yearMonth);
        showOrHide.add(startDate);
        showOrHide.add(lastModifiedDate);
        showOrHide.add(stdStartTime);
        showOrHide.add(stdEndTime);
        showOrHide.add(empToday);
		//debugç”¨

        return showOrHide;        
    }

    public class TimeTableResponse {
        public List<Map<String, Integer>> timeTable;
        public Boolean isHoliday;
    }
                    
    //å‡ºå‹¤æ‰“åˆ»
	@AuraEnabled
    public static LIST<String> getInsertAttendance() {
        //åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å–å¾—
        loadDataResponseData ld = loadData() ;
        //åˆæœŸãƒ‡ãƒ¼ã‚¿ã®é…ç½®
        List<teamspirit__AtkEmpDay__c> empDays = ld.empDays;//å‹¤æ€ æ—¥æ¬¡ãƒªã‚¹ãƒˆ
        String empId = ld.empId;
        Integer yearMonth = ld.yearMonth;
        String startDate = ld.startDate;
        String lastModifiedDate = ld.lastModifiedDate;
        Integer stdStartTime = ld.stdStartTime;
        Integer stdEndTime = ld.stdEndTime;
        teamspirit__AtkEmpDay__c empToday = ld.empToday; //ä»Šæ—¥ã®å‹¤æ€ æ—¥æ¬¡   
        Map<String, Object> lastData = ld.lastData;
        //åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ã“ã“ã¾ã§
        
        //getTimeTable ã‚¿ã‚¤ãƒ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å–å¾—ã™ã‚‹
        timeTableResponseData ttrd = new timeTableResponseData();
		TimeTableResponse resTmp = new TimeTableResponse();
        List<Map<String, Integer>> timeTable = new List<Map<String, Integer>>();
        ttrd = getTimeTable(resTmp,empToday,timeTable); 
		
        //çµæœå‡ºåŠ›ç”¨
        LIST<String> insertAttendance = new LIST<String>();

        //inputTimeTable
        Map<String, Object> params = getBaseParams( empId, yearMonth, startDate,lastModifiedDate);
		//inputTimeTable

        //setAttendance
        DateTime now = DateTime.now();
        Integer timeHM = now.hour() * 60 + now.minute();
        Map<String, Object> input = new Map<String, Object>{'comment' => '', 'time' => timeHM, 'face' => 1, 'fix' => false, 'type' => 10};
        params.put('input', input);
        params.put('prevFlag', false);
        params.put('stdStartTime', stdStartTime);
        params.put('stdEndTime', stdEndTime);
        String jsonReqSetAttendance = JSON.serialize(params);
        system.debug('jsonReqSetAttendance ' + jsonReqSetAttendance);
        Map<String, Object> resSetAttendance = teamspirit.RtkPotalCtl.inputTime(jsonReqSetAttendance);
        lastModifiedDate = String.valueOf(resSetAttendance.get('lastModifiedDate'));
        //ç¾åœ¨æ™‚åˆ»ã®å–å¾—
        Integer nowHour = now.hour();
        
        if(resSetAttendance.get('result') == 'OK'){
            insertAttendance.add('false');//cardã®éè¡¨ç¤º
	        if(nowHour<=15){//ã€œ15:59
            	insertAttendance.add('<p class="slds-text-color_success">ğŸ‘å‡ºå‹¤ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸğŸ‘</p>');
            }else{
            	insertAttendance.add('<p class="slds-text-color_success">ğŸ˜€ğŸ˜Œé€€å‹¤ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸğŸ‘<br />ä»Šæ—¥ã‚‚ä¸€æ—¥ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ»</p>');                
            }
        }else{
            insertAttendance.add('false');//cardã®éè¡¨ç¤º
	        if(nowHour<=15){//ã€œ15:59
            	insertAttendance.add('<p class="slds-text-color_error">ğŸ˜±ğŸ˜±å‡ºå‹¤ç™»éŒ²ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚Georgeã¾ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„' + resSetAttendance + '</p>');
            }else{
            	insertAttendance.add('<p class="slds-text-color_error">ğŸ˜±ğŸ˜±é€€å‹¤ç™»éŒ²ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚Georgeã¾ã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„' + resSetAttendance + '</p>');                
            }
        }
        //setAttendanceã“ã“ã¾ã§
        return insertAttendance;
    }

    //https://github.com/ngs/ts-dakoku/blob/master/apex/src/classes/TSTimeTableAPIController.cls

    //loadDataã§è¿”ã£ã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹
    public class loadDataResponseData {
        public Map<String, Object> lastData;
        public List<teamspirit__AtkEmpDay__c> empDays;
        public String empId;
        public Integer yearMonth;
        public String startDate;
        public String lastModifiedDate;
        public Integer stdStartTime;
        public Integer stdEndTime;
        public teamspirit__AtkEmpDay__c empToday;
    }
    
    //åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
    @AuraEnabled
    public static loadDataResponseData loadData() {
        loadDataResponseData res = new loadDataResponseData();
		res.lastData = teamspirit.RtkPotalCtl.getLastModifiedDate();//è‡ªåˆ†ã®æœ€çµ‚æ›´æ–°ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹æ¨¡æ§˜
        res.empId = (String) res.lastData.get('empId');//ç¤¾å“¡IDã‚’å–å¾—
        res.lastModifiedDate = String.valueOf(res.lastData.get('lastModifiedDate'));//æœ€çµ‚æ›´æ–°æ—¥ã‚’å–å¾—
        Map<String, Object> empMonth = teamspirit.RtkPotalCtl.loadEmpMonth('');//å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼Ÿ
        List<teamspirit__AtkConfig__c > configs = (List<teamspirit__AtkConfig__c>) empMonth.get('configs');//empMonthã®ä¸­ã«ã„ã‚ã‚“ãªãƒ‡ãƒ¼ã‚¿ãŒå…¥ã£ã¦ã„ã‚‹æ¨¡æ§˜ã€‚configã‚’å–ã£ã¦ãã‚‹
        teamspirit__AtkConfig__c config = configs != null && configs.size() > 0 ? configs[0] : null;
        if (config != null) {
            res.stdStartTime = Integer.valueOf(config.teamspirit__StdStartTime__c);
            res.stdEndTime = Integer.valueOf(config.teamspirit__StdEndTime__c);
        }
        res.empDays = (List<teamspirit__AtkEmpDay__c>) empMonth.get('empDays');//å‹¤æ€ æ—¥æ¬¡ã®ãƒªã‚¹ãƒˆãŒempDaysã§ãƒãƒƒãƒ—ã•ã‚Œã¦å…¥ã£ã¦ã„ã‚‹æ¨¡æ§˜
        if (res.empDays == null) {//empDaysãŒæœªä½œæˆã ã£ãŸå ´åˆã¯ä½œæˆã™ã‚‹ã£ã½ã„
            res.empDays = new List<teamspirit__AtkEmpDay__c>();
        }
        Date today = getToday();
        for (teamspirit__AtkEmpDay__c day: res.empDays) {
            if (day.teamspirit__Date__c == today) {//ä»Šæ—¥åˆ¤å®šã‚’ã—ã¦ä»Šæ—¥ã®æ—¥ä»˜ãŒå‡ºãŸã‚‰empTodayã‚’dayã«å…¥ã‚Œã¦break
                res.empToday = day;
                break;
            }
        }
        res.yearMonth = (Integer) empMonth.get('yearMonth');
        res.startDate = (String) empMonth.get('startDate');
        
        return res;
    }


    //loadDataã§è¿”ã£ã¦ãã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹
    public class timeTableResponseData {
        public TimeTableResponse ttr;
        public List<Map<String, Integer>> timeTable;
    }

    //TimeTableã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹
    public static timeTableResponseData getTimeTable(TimeTableResponse res,teamspirit__AtkEmpDay__c empToday,List<Map<String, Integer>> timeTable) { //å‹¤æ€ æ—¥æ¬¡>æ™‚é–“é…åˆ†ã®å–å¾—
        timeTableResponseData ttrd = new timeTableResponseData();
        res.isHoliday = isHoliday(empToday);
        res.timeTable = timeTable;
        if (empToday == null) {
            ttrd.ttr = res;
            return ttrd;
        }

        Map<String, Integer> item = new Map<String, Integer>();
        item.put('from', Integer.valueOf(empToday.teamspirit__StartTime__c));
        item.put('to', Integer.valueOf(empToday.teamspirit__EndTime__c));
        item.put('type', 1);
        timeTable.add(item);

        List<String> timeTableStrItems = (empToday.teamspirit__TimeTable__c == null ? '' : empToday.teamspirit__TimeTable__c).split(':');
        for (String timeTableStr: timeTableStrItems) {
            if(timeTableStr == '') {
                continue;
            }
            item = new Map<String, Integer>{};

                String str = timeTableStr.substring(0, 4);
            str = timeTableStr.substring(0, 4);
            if (str != '----') {
                item.put('from', Integer.valueOf(str));
            }
            str = timeTableStr.substring(4, 8);
            if (str != '----') {
                item.put('to', Integer.valueOf(str));
            }
            str = timeTableStr.substring(8, 10);
            item.put('type', Integer.valueOf(str));

            timeTable.add(item);
        }

        ttrd.ttr = res;
        ttrd.timeTable= timeTable;
        return ttrd;
    }    


    
    private static Date getToday() {
        return Date.today();
    }

    public static Boolean isHoliday(teamspirit__AtkEmpDay__c empToday) {
        return empToday != null && empToday.teamspirit__DayType__c != null && Integer.valueOf(empToday.teamspirit__DayType__c) > 0 && empToday.teamspirit__HolidayWorkApplyId__c == null;
    }

    private static Map<String, Object>getBaseParams(String empId,Integer yearMonth,String startDate,String lastModifiedDate) {
        Map<String, Object> params = new Map<String, Object>();
        params.put('empId', empId);
        params.put('month', yearMonth);
        params.put('startDate', startDate);
        params.put('lastModifiedDate', lastModifiedDate);
        params.put('date', DateTime.newInstance(getToday(), Time.newInstance(0, 0, 0, 0)).format('yyyy-MM-dd'));
        return params;
    }
}
